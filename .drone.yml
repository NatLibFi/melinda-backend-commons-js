---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:

  - name: audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true      
    commands:
      - npm ci

  - name: test
    image: node:12
    commands:
      - npm test
  
  # Disabled because the original code didn't have coverage checking at all and tests aren't very comprehensive
  #- name: check-coverage
  #  image: node:12
  #  commands:
  #    - npm run coverage

  - name: build
    image: node:12
    commands:
      - npm run build
      - npm ci --production

  - name: static-security-scan
    image: quay.io/natlibfi/njsscan
    commands:
      - njsscan dist

  - name: npm
    image: plugins/npm
    settings:
      registry: 'https://registry.npmjs.org/'
      token:
        from_secret: npm_token
    when:
      event: tag 
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - master

steps:

  - name: publish
    image: quay.io/natlibfi/drone-npm-git-publish
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: ssh_key
      git_gpg_key:
        from_secret: gpg_key
---
kind: secret
name: npm_token
data: ZWucH1tDADcjRFH3wuxAXIo7w6mssMU/etLMMDdps17u4ds/HBShUuUl17FWyQGYxebnIgWBPeCpAk20XMPTlQ==
---
kind: secret
name: ssh_key
data: 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
---
kind: secret
name: gpg_key
data: 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
---
kind: signature
hmac: eaceed1fe0062eb6c81d5b3acc2bda83913157f813d525a099da343b9d44dde0

...
